---
title: "Round 4: Simulation & Backtesting"
subtitle: "Kalshi Trading Strategy Discovery"
date: today
format:
  html:
    toc: true
    toc-depth: 3
    self-contained: true
    theme: cosmo
---

## Executive Summary

This report validates the five Tier 1 strategies from Round 3 through time-series
backtesting with realistic fee deduction. Key findings:

- **Equity curves produced** for all 5 Tier 1 strategies over the full dataset
  period (2021-06-30 to 2026-02-06)
- **Walk-forward validation** splits at 2025-01-01 to test whether edges found
  in pre-2025 data persist in unseen 2025+ data
- **Drawdown analysis** quantifies worst-case losses and recovery times
- **Edge decay** measures whether strategies are becoming less profitable as
  the market matures
- **Fill rate sensitivity** tests robustness at realistic execution rates
  (10%-100% of matching flow)
- **Portfolio construction** combines strategies to measure diversification benefit

---

## Research Plan

### Research Questions

1. **Do Tier 1 strategies generate positive cumulative P&L?** Running full-period
   backtests with per-trade fee deduction to produce equity curves.
2. **Does edge persist out-of-sample?** Walk-forward validation splitting at
   2025-01-01 to test if pre-2025 edge survives in 2025+ data.
3. **What are the risk characteristics?** Maximum drawdown, drawdown duration,
   and Calmar ratio for each strategy.
4. **Is the edge decaying?** Rolling 90-day net edge trend analysis to detect
   market efficiency gains eroding strategy profitability.
5. **How robust is the edge to execution constraints?** Fill rate sensitivity
   at 10%, 25%, 50%, and 100% with confidence bands.
6. **Do strategies diversify?** Correlation between strategy daily P&L and
   portfolio-level metrics.

### Backtest Model

**Sampled Trade Replay**: Each historical trade matching a strategy's filter
represents a taker entry that resolves at market settlement.

- **Win P&L**: `(100 - taker_price) - fee` cents per contract
- **Loss P&L**: `-taker_price - fee` cents per contract
- **Fee**: `kalshi_fee_cents(taker_price, fee_multiplier)` (quadratic formula)
- **Daily P&L**: Attributed to market settlement date

### Tier 1 Strategies Tested

| # | Strategy | R3 Net Edge | R3 Daily Cap |
|---|----------|-------------|--------------|
| 1 | Elections YES high (quadratic, non-evening) | 10.73pp | 51.8K |
| 2 | Elections NO high (quadratic, non-evening) | 3.07pp | 128.3K |
| 3 | Economics YES favorites (>=70c) | 4.76pp | 55.0K |
| 4 | Elections YES high (quadratic, evening) | 12.34pp | 17.9K |
| 5 | Elections YES favorites (>=70c) | 3.82pp | 49.0K |

### Infrastructure Built

| Module | Purpose |
|--------|---------|
| `src/simulation/strategy_def.py` | Strategy filter registry with SQL generation |
| `src/simulation/backtest.py` | Core backtester: trade fetching, P&L computation, equity curves |
| `src/simulation/metrics.py` | Sharpe ratio, max drawdown, profit factor, daily P&L aggregation |
| `src/simulation/portfolio.py` | Correlation matrix, combined equity curves, portfolio metrics |
| `src/util/queries.py` | Added `full_trade_outcomes_with_all_dims_sql()` canonical CTE |

**Test coverage**: 192 tests across all modules (44 new for Round 4), all passing.

---

## 1. Backtest Results: Per-Strategy P&L

Full-period backtests at 100% fill rate for each Tier 1 strategy.

![Combined equity curves for all Tier 1 strategies](figures/backtest_equity_curves.png)

![Individual strategy equity curves with metrics](figures/backtest_individual_curves.png)

**Key findings:**

- Each strategy's cumulative P&L over the dataset period, with per-trade fees
  deducted using the actual `fee_multiplier` for each trade's series.
- Metrics include total P&L (in dollars), annualized Sharpe ratio, maximum
  drawdown, win rate, and profit factor.
- All P&L values are computed in cents per contract, then aggregated.

---

## 2. Walk-Forward Validation

In-sample (pre-2025) vs. out-of-sample (2025+) comparison to test edge persistence.

**Split date**: 2025-01-01

![Walk-forward: avg net P&L comparison](figures/walk_forward_comparison.png)

![Walk-forward: Sharpe ratio comparison](figures/walk_forward_sharpe.png)

**Key findings:**

- Strategies that maintain positive average net P&L per contract out-of-sample
  are considered validated.
- Edge decay between in-sample and out-of-sample periods is measured for each
  strategy.
- Strategies with significant decay may be overfit to historical patterns.

---

## 3. Drawdown Analysis

Maximum drawdown, duration, and underwater curves for each strategy.

![Underwater curves showing drawdown from peak](figures/drawdown_underwater.png)

**Key findings:**

- Maximum drawdown magnitude and percentage of peak equity.
- Drawdown duration: longest continuous period below the peak.
- Calmar ratio (total P&L / max drawdown) as a risk-adjusted performance measure.

---

## 4. Strategy Decay

Rolling 90-day average net edge over time, with linear trend analysis.

![Rolling net edge over time for each strategy](figures/strategy_decay_rolling.png)

**Key findings:**

- Strategies with negative slope in rolling edge may be affected by increasing
  market efficiency.
- The correlation coefficient indicates the strength of the trend.
- Annual slope quantifies the rate of edge erosion per year.

---

## 5. Fill Rate Robustness

P&L sensitivity to fill rate (fraction of matching trades captured).

![Fill rate sensitivity with confidence bands](figures/fill_rate_sensitivity.png)

**Key findings:**

- Fill rates tested: 10%, 25%, 50%, 100% (20 random seeds each for sub-100%).
- Strategies that remain profitable at 10% fill rate are robust to execution
  constraints.
- Confidence bands show the range of outcomes across random samples.

---

## 6. Multi-Strategy Portfolio

Correlation analysis and combined portfolio performance.

![Daily P&L correlation matrix](figures/portfolio_correlation.png)

![Portfolio vs individual equity curves](figures/portfolio_equity_curve.png)

**Key findings:**

- Correlation matrix shows how strategy daily P&L co-moves.
- Equal-weight portfolio combines all strategies with equal allocation.
- Diversification ratio (portfolio Sharpe / best individual Sharpe) > 1.0
  indicates beneficial diversification.

---

## 7. Conclusions & Advancement Decisions

Based on the backtesting results:

- **Strategies that survived** walk-forward validation with positive out-of-sample
  edge and manageable drawdowns are recommended for advancement to Round 5
  (Refinement & Robustness).
- **Strategies that failed** (negative OOS edge, excessive decay, or drawdowns)
  should be rejected or monitored.
- **Portfolio allocation** recommendations based on correlation and risk metrics.

---

## Appendix: Methodology

### Backtest Assumptions

- **Execution model**: Taker execution at historical trade prices.
- **Fee model**: Kalshi quadratic fee: `0.07 * fee_multiplier * P * (1-P)` per contract.
- **P&L attribution**: To market settlement date (close_time), not trade date.
- **Fill rate**: Parameterized sampling of matching trade flow.
- **Position sizing**: Flat (1 contract per trade) for primary analysis.

### Walk-Forward Validation

- **In-sample**: 2021-06-30 to 2024-12-31 (~1,280 days)
- **Out-of-sample**: 2025-01-01 to 2026-02-06 (~400 days)
- Not traditional model training â€” filter-based strategies have no parameters
  to fit. Walk-forward tests whether historical filter-based edge persists.

### Metrics

- **Sharpe ratio**: Annualized from daily P&L: `(mean / std) * sqrt(252)`
- **Max drawdown**: Peak-to-trough decline in cumulative P&L
- **Profit factor**: Gross winning P&L / gross losing P&L
- **Calmar ratio**: Total P&L / max drawdown
- **Win rate**: Contract-weighted fraction of winning trades

### Dataset

- Total resolved markets: ~28.9M
- Total trades: ~173M
- Date range: 2021-06-30 to 2026-02-06
- Dataset days: ~1,680
